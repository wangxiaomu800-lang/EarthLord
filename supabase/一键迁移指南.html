<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°çƒæ–°ä¸» - æ•°æ®åº“è¿ç§»æŒ‡å—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        .content {
            padding: 40px;
        }
        .step {
            margin-bottom: 30px;
            padding: 25px;
            background: #f7f9fc;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        .step h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .step p {
            color: #444;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        .sql-container {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            position: relative;
        }
        .sql-container pre {
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .copy-btn:hover {
            background: #5568d3;
        }
        .success-message {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .success-message h3 {
            color: #065f46;
            margin-bottom: 10px;
        }
        .success-message ul {
            margin-left: 20px;
            color: #065f46;
        }
        .success-message li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ æ•°æ®åº“è¿ç§»æŒ‡å—</h1>
            <p>åœ°çƒæ–°ä¸» - é™„è¿‘ç©å®¶æ£€æµ‹ç³»ç»Ÿ</p>
        </div>

        <div class="content">
            <div class="step">
                <h2>ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šæ‰“å¼€ Supabase SQL Editor</h2>
                <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ Supabase Dashboard çš„ SQL Editor é¡µé¢</p>
                <div class="button-group">
                    <a href="https://supabase.com/dashboard/project/vuqfufnrxzsmkzmhtuhw/sql/new"
                       target="_blank"
                       class="btn btn-primary">
                        ğŸŒ æ‰“å¼€ SQL Editor
                    </a>
                </div>
            </div>

            <div class="step">
                <h2>ğŸ“ ç¬¬äºŒæ­¥ï¼šå¤åˆ¶ SQL ä»£ç </h2>
                <p>ç‚¹å‡»ä¸‹æ–¹çš„"å¤åˆ¶ SQL"æŒ‰é’®ï¼Œå°†è¿ç§»è„šæœ¬å¤åˆ¶åˆ°å‰ªè´´æ¿</p>
                <div class="sql-container" id="sqlContainer">
                    <button class="copy-btn" onclick="copySql()">ğŸ“‹ å¤åˆ¶ SQL</button>
                    <pre id="sqlCode">-- åœ°çƒæ–°ä¸» - ç©å®¶ä½ç½®è¿½è¸ªç³»ç»Ÿ
-- åˆ›å»ºæ—¶é—´: 2026-01-14

-- ============================================================================
-- 1. å¯ç”¨ PostgreSQL åœ°ç†æ‰©å±•
-- ============================================================================

CREATE EXTENSION IF NOT EXISTS cube;
CREATE EXTENSION IF NOT EXISTS earthdistance;

-- ============================================================================
-- 2. PLAYER_LOCATIONS è¡¨ï¼ˆç©å®¶ä½ç½®è®°å½•ï¼‰
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.player_locations (
    player_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    latitude DOUBLE PRECISION NOT NULL,
    longitude DOUBLE PRECISION NOT NULL,
    last_update_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    is_online BOOLEAN NOT NULL DEFAULT TRUE,
    earth_location EARTH,
    CONSTRAINT valid_latitude CHECK (latitude >= -90 AND latitude <= 90),
    CONSTRAINT valid_longitude CHECK (longitude >= -180 AND longitude <= 180)
);

CREATE INDEX IF NOT EXISTS idx_player_locations_earth
    ON public.player_locations USING GIST(earth_location);

CREATE INDEX IF NOT EXISTS idx_player_locations_last_update
    ON public.player_locations(last_update_time);

CREATE INDEX IF NOT EXISTS idx_player_locations_is_online
    ON public.player_locations(is_online);

ALTER TABLE public.player_locations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "å·²è®¤è¯ç”¨æˆ·å¯ä»¥è¯»å–ä½ç½®è®°å½•ç”¨äºç»Ÿè®¡"
    ON public.player_locations FOR SELECT TO authenticated USING (true);

CREATE POLICY "ç©å®¶å¯ä»¥æ›´æ–°è‡ªå·±çš„ä½ç½®"
    ON public.player_locations FOR UPDATE TO authenticated
    USING (auth.uid() = player_id) WITH CHECK (auth.uid() = player_id);

CREATE POLICY "ç©å®¶å¯ä»¥æ’å…¥è‡ªå·±çš„ä½ç½®è®°å½•"
    ON public.player_locations FOR INSERT TO authenticated
    WITH CHECK (auth.uid() = player_id);

-- ============================================================================
-- 3. è‡ªåŠ¨æ›´æ–° earth_location å­—æ®µçš„è§¦å‘å™¨
-- ============================================================================

CREATE OR REPLACE FUNCTION update_earth_location()
RETURNS TRIGGER AS $$
BEGIN
    NEW.earth_location := ll_to_earth(NEW.latitude, NEW.longitude);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_player_location_earth
    BEFORE INSERT OR UPDATE OF latitude, longitude ON public.player_locations
    FOR EACH ROW EXECUTE FUNCTION update_earth_location();

-- ============================================================================
-- 4. RPC å‡½æ•°ï¼šç»Ÿè®¡é™„è¿‘ç©å®¶æ•°é‡
-- ============================================================================

CREATE OR REPLACE FUNCTION count_nearby_players(
    user_lat DOUBLE PRECISION,
    user_lng DOUBLE PRECISION,
    radius_meters DOUBLE PRECISION DEFAULT 1000
)
RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    nearby_count INTEGER;
    online_threshold TIMESTAMPTZ;
BEGIN
    online_threshold := NOW() - INTERVAL '5 minutes';

    SELECT COUNT(*)
    INTO nearby_count
    FROM public.player_locations
    WHERE
        player_id != auth.uid()
        AND last_update_time >= online_threshold
        AND is_online = true
        AND earth_box(ll_to_earth(user_lat, user_lng), radius_meters)
            @> ll_to_earth(latitude, longitude)
        AND earth_distance(ll_to_earth(user_lat, user_lng), ll_to_earth(latitude, longitude))
            <= radius_meters;

    RETURN nearby_count;
END;
$$;

-- ============================================================================
-- 5. RPC å‡½æ•°ï¼šå»ºè®® POI æ˜¾ç¤ºæ•°é‡
-- ============================================================================

CREATE OR REPLACE FUNCTION suggest_poi_count(
    nearby_player_count INTEGER
)
RETURNS INTEGER
LANGUAGE plpgsql
IMMUTABLE
AS $$
BEGIN
    CASE
        WHEN nearby_player_count = 0 THEN RETURN 1;
        WHEN nearby_player_count BETWEEN 1 AND 5 THEN RETURN 3;
        WHEN nearby_player_count BETWEEN 6 AND 20 THEN RETURN 6;
        ELSE RETURN 20;
    END CASE;
END;
$$;

-- ============================================================================
-- 6. æ·»åŠ æ³¨é‡Š
-- ============================================================================

COMMENT ON TABLE public.player_locations IS 'ç©å®¶ä½ç½®è®°å½•è¡¨ï¼Œç”¨äºé™„è¿‘ç©å®¶æ£€æµ‹';
COMMENT ON FUNCTION count_nearby_players IS 'ç»Ÿè®¡é™„è¿‘åœ¨çº¿ç©å®¶æ•°é‡ï¼ˆä¸åŒ…æ‹¬è‡ªå·±ï¼‰';
COMMENT ON FUNCTION suggest_poi_count IS 'æ ¹æ®é™„è¿‘ç©å®¶æ•°é‡å»ºè®® POI æ˜¾ç¤ºæ•°é‡';</pre>
                </div>
            </div>

            <div class="step">
                <h2>â–¶ï¸ ç¬¬ä¸‰æ­¥ï¼šç²˜è´´å¹¶æ‰§è¡Œ</h2>
                <p>1. åœ¨ SQL Editor ä¸­ï¼Œå°†å¤åˆ¶çš„ SQL ç²˜è´´åˆ°ç¼–è¾‘å™¨ä¸­</p>
                <p>2. ç‚¹å‡»å³ä¸Šè§’çš„ <strong>"Run"</strong> æŒ‰é’®æ‰§è¡Œ</p>
                <p>3. ç­‰å¾…æ‰§è¡Œå®Œæˆï¼ˆå¤§çº¦ 2-3 ç§’ï¼‰</p>
            </div>

            <div class="success-message">
                <h3>âœ… æ‰§è¡ŒæˆåŠŸåï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š</h3>
                <ul>
                    <li>âœ… Extensions created: <strong>cube</strong>, <strong>earthdistance</strong></li>
                    <li>âœ… Table created: <strong>player_locations</strong></li>
                    <li>âœ… Functions created: <strong>count_nearby_players</strong>, <strong>suggest_poi_count</strong></li>
                    <li>âœ… Indexes created: <strong>3 ä¸ªç´¢å¼•</strong></li>
                    <li>âœ… RLS policies created: <strong>3 ä¸ªç­–ç•¥</strong></li>
                </ul>
            </div>

            <div class="step">
                <h2>ğŸ® ç¬¬å››æ­¥ï¼šé‡æ–°æµ‹è¯• App</h2>
                <p>æ‰§è¡Œå®Œæˆåï¼Œé‡æ–°è¿è¡Œ App å¹¶å¼€å§‹æ¢ç´¢ï¼Œæ—¥å¿—ä¸­åº”è¯¥æ˜¾ç¤ºï¼š</p>
                <div class="sql-container">
                    <pre>ğŸ“ å¼€å§‹ä½ç½®ä¸ŠæŠ¥ï¼ˆæ¯ 30 ç§’ï¼‰
âœ… ä½ç½®ä¸ŠæŠ¥æˆåŠŸ: (34.2890, 107.7218)
ğŸ” æŸ¥è¯¢é™„è¿‘ç©å®¶æ•°é‡...
âœ… é™„è¿‘æœ‰ 0 ä¸ªåœ¨çº¿ç©å®¶ - ç‹¬è¡Œè€…
ğŸ’¡ å»ºè®®æ˜¾ç¤º 1 ä¸ª POIï¼ˆé™„è¿‘ 0 ä¸ªç©å®¶ï¼‰
âœ… æ‰¾åˆ° 1 ä¸ª POI</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        function copySql() {
            const sqlCode = document.getElementById('sqlCode').textContent;
            navigator.clipboard.writeText(sqlCode).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²å¤åˆ¶ï¼';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
            });
        }
    </script>
</body>
</html>
