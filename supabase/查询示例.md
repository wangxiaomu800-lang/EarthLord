# Supabase æŸ¥è¯¢ç¤ºä¾‹ - åœ°çƒæ–°ä¸»

## ğŸ”§ å‰ææ¡ä»¶

ç¡®ä¿ä½ å·²ç»åˆå§‹åŒ–äº† Supabase å®¢æˆ·ç«¯ï¼š

```swift
import Supabase

let supabase = SupabaseClient(
    supabaseURL: URL(string: "https://vuqfufnrxzsmkzmhtuhw.supabase.co")!,
    supabaseKey: "sb_publishable_sej6ww803g00vIuiXFjhFQ_JdRV2QHk",
    options: SupabaseClientOptions(
        auth: AuthClientOptions(
            emitLocalSessionAsInitialSession: true
        )
    )
)
```

---

## 1ï¸âƒ£ æŸ¥è¯¢ Profilesï¼ˆç”¨æˆ·èµ„æ–™ï¼‰

### å®šä¹‰æ•°æ®æ¨¡å‹

```swift
struct Profile: Codable, Identifiable {
    let id: UUID
    let username: String
    let avatar_url: String?
    let created_at: Date
    let updated_at: Date
}
```

### æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·

```swift
func fetchAllProfiles() async throws -> [Profile] {
    let profiles: [Profile] = try await supabase
        .from("profiles")
        .select()
        .execute()
        .value

    return profiles
}
```

### æŸ¥è¯¢å•ä¸ªç”¨æˆ·ï¼ˆé€šè¿‡ IDï¼‰

```swift
func fetchProfile(userId: UUID) async throws -> Profile? {
    let profiles: [Profile] = try await supabase
        .from("profiles")
        .select()
        .eq("id", value: userId.uuidString)
        .limit(1)
        .execute()
        .value

    return profiles.first
}
```

### æŸ¥è¯¢å•ä¸ªç”¨æˆ·ï¼ˆé€šè¿‡ç”¨æˆ·åï¼‰

```swift
func fetchProfile(username: String) async throws -> Profile? {
    let profiles: [Profile] = try await supabase
        .from("profiles")
        .select()
        .eq("username", value: username)
        .limit(1)
        .execute()
        .value

    return profiles.first
}
```

### åˆ›å»ºæ–°ç”¨æˆ·èµ„æ–™

```swift
func createProfile(userId: UUID, username: String, avatarUrl: String? = nil) async throws {
    struct NewProfile: Encodable {
        let id: UUID
        let username: String
        let avatar_url: String?
    }

    let newProfile = NewProfile(
        id: userId,
        username: username,
        avatar_url: avatarUrl
    )

    try await supabase
        .from("profiles")
        .insert(newProfile)
        .execute()
}
```

### æ›´æ–°ç”¨æˆ·èµ„æ–™

```swift
func updateProfile(userId: UUID, username: String? = nil, avatarUrl: String? = nil) async throws {
    struct ProfileUpdate: Encodable {
        let username: String?
        let avatar_url: String?
    }

    let update = ProfileUpdate(
        username: username,
        avatar_url: avatarUrl
    )

    try await supabase
        .from("profiles")
        .update(update)
        .eq("id", value: userId.uuidString)
        .execute()
}
```

---

## 2ï¸âƒ£ æŸ¥è¯¢ Territoriesï¼ˆé¢†åœ°ï¼‰

### å®šä¹‰æ•°æ®æ¨¡å‹

```swift
struct Territory: Codable, Identifiable {
    let id: UUID
    let user_id: UUID
    let name: String
    let path: [[String: Double]] // [{lat: 39.9, lng: 116.4}, ...]
    let area: Double
    let created_at: Date
    let updated_at: Date
}
```

### æŸ¥è¯¢æ‰€æœ‰é¢†åœ°

```swift
func fetchAllTerritories() async throws -> [Territory] {
    let territories: [Territory] = try await supabase
        .from("territories")
        .select()
        .order("created_at", ascending: false)
        .execute()
        .value

    return territories
}
```

### æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰é¢†åœ°

```swift
func fetchUserTerritories(userId: UUID) async throws -> [Territory] {
    let territories: [Territory] = try await supabase
        .from("territories")
        .select()
        .eq("user_id", value: userId.uuidString)
        .order("created_at", ascending: false)
        .execute()
        .value

    return territories
}
```

### åˆ›å»ºæ–°é¢†åœ°

```swift
func createTerritory(
    userId: UUID,
    name: String,
    path: [[String: Double]],
    area: Double
) async throws -> Territory {
    struct NewTerritory: Encodable {
        let user_id: UUID
        let name: String
        let path: [[String: Double]]
        let area: Double
    }

    let newTerritory = NewTerritory(
        user_id: userId,
        name: name,
        path: path,
        area: area
    )

    let result: Territory = try await supabase
        .from("territories")
        .insert(newTerritory)
        .select()
        .single()
        .execute()
        .value

    return result
}
```

### åˆ é™¤é¢†åœ°

```swift
func deleteTerritory(territoryId: UUID) async throws {
    try await supabase
        .from("territories")
        .delete()
        .eq("id", value: territoryId.uuidString)
        .execute()
}
```

---

## 3ï¸âƒ£ æŸ¥è¯¢ POIsï¼ˆå…´è¶£ç‚¹ï¼‰

### å®šä¹‰æ•°æ®æ¨¡å‹

```swift
enum POIType: String, Codable {
    case hospital
    case supermarket
    case factory
    case gas_station = "gas_station"
    case police
    case school
    case park
    case restaurant
    case other
}

struct POI: Codable, Identifiable {
    let id: String
    let poi_type: POIType
    let name: String
    let latitude: Double
    let longitude: Double
    let discovered_by: UUID?
    let discovered_at: Date
}
```

### æŸ¥è¯¢æ‰€æœ‰ POI

```swift
func fetchAllPOIs() async throws -> [POI] {
    let pois: [POI] = try await supabase
        .from("pois")
        .select()
        .execute()
        .value

    return pois
}
```

### æŒ‰ç±»å‹æŸ¥è¯¢ POI

```swift
func fetchPOIs(ofType type: POIType) async throws -> [POI] {
    let pois: [POI] = try await supabase
        .from("pois")
        .select()
        .eq("poi_type", value: type.rawValue)
        .execute()
        .value

    return pois
}
```

### æŸ¥è¯¢ç”¨æˆ·å‘ç°çš„ POI

```swift
func fetchUserDiscoveredPOIs(userId: UUID) async throws -> [POI] {
    let pois: [POI] = try await supabase
        .from("pois")
        .select()
        .eq("discovered_by", value: userId.uuidString)
        .order("discovered_at", ascending: false)
        .execute()
        .value

    return pois
}
```

### åˆ›å»ºæ–° POIï¼ˆå‘ç°ï¼‰

```swift
func discoverPOI(
    id: String,
    type: POIType,
    name: String,
    latitude: Double,
    longitude: Double,
    discoveredBy: UUID
) async throws {
    struct NewPOI: Encodable {
        let id: String
        let poi_type: String
        let name: String
        let latitude: Double
        let longitude: Double
        let discovered_by: UUID
    }

    let newPOI = NewPOI(
        id: id,
        poi_type: type.rawValue,
        name: name,
        latitude: latitude,
        longitude: longitude,
        discovered_by: discoveredBy
    )

    try await supabase
        .from("pois")
        .insert(newPOI)
        .execute()
}
```

### æŸ¥è¯¢é™„è¿‘çš„ POIï¼ˆä½¿ç”¨èŒƒå›´æŸ¥è¯¢ï¼‰

```swift
func fetchNearbyPOIs(
    centerLat: Double,
    centerLng: Double,
    radiusInDegrees: Double = 0.1 // çº¦ 11 å…¬é‡Œ
) async throws -> [POI] {
    let pois: [POI] = try await supabase
        .from("pois")
        .select()
        .gte("latitude", value: centerLat - radiusInDegrees)
        .lte("latitude", value: centerLat + radiusInDegrees)
        .gte("longitude", value: centerLng - radiusInDegrees)
        .lte("longitude", value: centerLng + radiusInDegrees)
        .execute()
        .value

    return pois
}
```

---

## ğŸ” å¸¸è§æŸ¥è¯¢é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### âŒ é—®é¢˜ 1: "Could not find the table"

**åŸå› **: è¡¨ä¸å­˜åœ¨æˆ– migration æœªæ‰§è¡Œ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# åœ¨ Supabase Dashboard SQL Editor ä¸­æ‰§è¡Œ migration
# æ–‡ä»¶: supabase/migrations/20251226_create_core_tables.sql
```

---

### âŒ é—®é¢˜ 2: æŸ¥è¯¢è¿”å›ç©ºæ•°ç»„ä½†æ²¡æŠ¥é”™

**åŸå› **: å¯èƒ½æ˜¯ RLS ç­–ç•¥é˜»æ­¢äº†è®¿é—®

**è§£å†³æ–¹æ¡ˆ 1** - æ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯:
```swift
// å¦‚æœéœ€è¦è®¤è¯ï¼Œå…ˆç™»å½•
try await supabase.auth.signIn(email: "user@example.com", password: "password")
```

**è§£å†³æ–¹æ¡ˆ 2** - åœ¨ Supabase Dashboard ä¸­æ£€æŸ¥ RLS ç­–ç•¥:
1. è¿›å…¥ Table Editor
2. é€‰æ‹©å¯¹åº”çš„è¡¨
3. ç‚¹å‡» "RLS" æ ‡ç­¾
4. ç¡®ä¿æœ‰ "SELECT" ç­–ç•¥å…è®¸å…¬å¼€è®¿é—®

---

### âŒ é—®é¢˜ 3: è§£ç é”™è¯¯ (DecodingError)

**åŸå› **: æ•°æ®æ¨¡å‹ä¸æ•°æ®åº“å­—æ®µä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**:
```swift
// ç¡®ä¿å­—æ®µåç§°å®Œå…¨åŒ¹é…ï¼ˆåŒ…æ‹¬å¤§å°å†™å’Œä¸‹åˆ’çº¿ï¼‰
struct Profile: Codable {
    let id: UUID
    let username: String
    let avatar_url: String? // æ³¨æ„ï¼šavatar_url ä¸æ˜¯ avatarUrl
    let created_at: Date    // æ³¨æ„ï¼šcreated_at ä¸æ˜¯ createdAt
    let updated_at: Date
}
```

æˆ–è€…ä½¿ç”¨ CodingKeysï¼š
```swift
struct Profile: Codable {
    let id: UUID
    let username: String
    let avatarURL: String?
    let createdAt: Date
    let updatedAt: Date

    enum CodingKeys: String, CodingKey {
        case id
        case username
        case avatarURL = "avatar_url"
        case createdAt = "created_at"
        case updatedAt = "updated_at"
    }
}
```

---

### âŒ é—®é¢˜ 4: æ—¥æœŸè§£æé”™è¯¯

**åŸå› **: Supabase è¿”å›çš„æ—¥æœŸæ ¼å¼éœ€è¦ç‰¹æ®Šå¤„ç†

**è§£å†³æ–¹æ¡ˆ**:
```swift
// æ–¹æ³• 1: ä½¿ç”¨ String ç±»å‹ï¼Œç¨åæ‰‹åŠ¨è§£æ
struct Profile: Codable {
    let id: UUID
    let username: String
    let avatar_url: String?
    let created_at: String // ä½¿ç”¨ String
    let updated_at: String
}

// æ–¹æ³• 2: é…ç½®è‡ªå®šä¹‰ DateDecodingStrategy
let decoder = JSONDecoder()
decoder.dateDecodingStrategy = .iso8601
```

---

## ğŸ“ åœ¨ SwiftUI View ä¸­ä½¿ç”¨ç¤ºä¾‹

```swift
import SwiftUI
import Supabase

struct ProfileListView: View {
    @State private var profiles: [Profile] = []
    @State private var isLoading = false
    @State private var errorMessage: String?

    var body: some View {
        NavigationView {
            Group {
                if isLoading {
                    ProgressView("åŠ è½½ä¸­...")
                } else if let error = errorMessage {
                    VStack {
                        Image(systemName: "exclamationmark.triangle")
                            .font(.largeTitle)
                        Text(error)
                            .foregroundColor(.red)
                        Button("é‡è¯•") {
                            Task { await loadProfiles() }
                        }
                    }
                } else {
                    List(profiles) { profile in
                        VStack(alignment: .leading) {
                            Text(profile.username)
                                .font(.headline)
                            Text("ID: \(profile.id.uuidString)")
                                .font(.caption)
                                .foregroundColor(.gray)
                        }
                    }
                }
            }
            .navigationTitle("ç”¨æˆ·åˆ—è¡¨")
        }
        .task {
            await loadProfiles()
        }
    }

    func loadProfiles() async {
        isLoading = true
        errorMessage = nil

        do {
            profiles = try await supabase
                .from("profiles")
                .select()
                .execute()
                .value
        } catch {
            errorMessage = "åŠ è½½å¤±è´¥: \(error.localizedDescription)"
        }

        isLoading = false
    }
}
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **å…ˆè¿è¡Œæ”¹è¿›åçš„æµ‹è¯•é¡µé¢**ï¼Œçœ‹çœ‹å…·ä½“çš„é”™è¯¯ä¿¡æ¯
2. **æ ¹æ®é”™è¯¯æç¤º**è¿›è¡Œç›¸åº”çš„ä¿®å¤
3. **å‚è€ƒæœ¬æ–‡æ¡£**çš„ç¤ºä¾‹ä»£ç æ¥å®ç°ä½ çš„åŠŸèƒ½

å¦‚æœæµ‹è¯•é¡µé¢æ˜¾ç¤ºäº†å…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šå¸®ä½ è§£å†³ï¼
